(function(){function e(){}function t(e){this.buttonBar=u.getElementById("wmd-button-bar"+e),this.preview=u.getElementById("wmd-preview"+e),this.input=u.getElementById("wmd-form-editor"+e),this.input||(this.input=u.getElementById("wmd-form-editor"+e))}function n(e,t){var n,r,o,a=this,s=[],c=0,d="none",u=function(e,t){d!=e&&(d=e,t||f()),h.isIE&&"moving"==d?o=null:r=setTimeout(p,1)},p=function(e){o=new i(t,e),r=void 0};this.setCommandMode=function(){d="command",f(),r=setTimeout(p,0)},this.canUndo=function(){return c>1},this.canRedo=function(){return!!s[c+1]},this.undo=function(){a.canUndo()&&(n?(n.restore(),n=null):(s[c]=new i(t),s[--c].restore(),e&&e())),d="none",t.input.focus(),p()},this.redo=function(){a.canRedo()&&(s[++c].restore(),e&&e()),d="none",t.input.focus(),p()};var f=function(){var r=o||new i(t);if(!r)return!1;"moving"!=d?(n&&(s[c-1].text!=n.text&&(s[c++]=n),n=null),s[c++]=r,s[c+1]=null,e&&e()):n||(n=r)},g=function(e){var t=!1;if((e.ctrlKey||e.metaKey)&&!e.altKey){var n=e.charCode||e.keyCode,i=String.fromCharCode(n);switch(i.toLowerCase()){case"y":a.redo(),t=!0;break;case"z":e.shiftKey?a.redo():a.undo(),t=!0}}if(t)return e.preventDefault&&e.preventDefault(),void(window.event&&(window.event.returnValue=!1))},m=function(e){if(!e.ctrlKey&&!e.metaKey){var t=e.keyCode;t>=33&&t<=40||t>=63232&&t<=63235?u("moving"):8==t||46==t||127==t?u("deleting"):13==t?u("newlines"):27==t?u("escape"):(t<16||t>20)&&91!=t&&u("typing")}},v=function(){l.addEvent(t.input,"keypress",function(e){!e.ctrlKey&&!e.metaKey||e.altKey||89!=e.keyCode&&90!=e.keyCode||e.preventDefault()});var e=function(){(h.isIE||o&&o.text!=t.input.value)&&null==r&&(d="paste",f(),p())};l.addEvent(t.input,"keydown",g),l.addEvent(t.input,"keydown",m),l.addEvent(t.input,"mousedown",function(){u("moving")}),t.input.onpaste=e,t.input.ondrop=e},b=function(){v(),p(!0),f()};b()}function i(t,n){var i=this,r=t.input;this.init=function(){l.isVisible(r)&&(!n&&u.activeElement&&u.activeElement!==r||(this.setInputAreaSelectionStartEnd(),this.scrollTop=r.scrollTop,(!this.text&&r.selectionStart||0===r.selectionStart)&&(this.text=r.value)))},this.setInputAreaSelection=function(){if(l.isVisible(r))if(void 0===r.selectionStart||h.isOpera){if(u.selection){if(u.activeElement&&u.activeElement!==r)return;r.focus();var e=r.createTextRange();e.moveStart("character",-r.value.length),e.moveEnd("character",-r.value.length),e.moveEnd("character",i.end),e.moveStart("character",i.start),e.select()}}else r.focus(),r.selectionStart=i.start,r.selectionEnd=i.end,r.scrollTop=i.scrollTop},this.setInputAreaSelectionStartEnd=function(){if(t.ieCachedRange||!r.selectionStart&&0!==r.selectionStart){if(u.selection){i.text=l.fixEolChars(r.value);var e=t.ieCachedRange||u.selection.createRange(),n=l.fixEolChars(e.text),o="",a=o+n+o;e.text=a;var s=l.fixEolChars(r.value);e.moveStart("character",-a.length),e.text=n,i.start=s.indexOf(o),i.end=s.lastIndexOf(o)-o.length;var c=i.text.length-l.fixEolChars(r.value).length;if(c){for(e.moveStart("character",-n.length);c--;)n+="\n",i.end+=1;e.text=n}t.ieCachedRange&&(i.scrollTop=t.ieCachedScrollTop),t.ieCachedRange=null,this.setInputAreaSelection()}}else i.start=r.selectionStart,i.end=r.selectionEnd},this.restore=function(){null!=i.text&&i.text!=r.value&&(r.value=i.text),this.setInputAreaSelection(),r.scrollTop=i.scrollTop},this.getChunks=function(){var t=new e;return t.before=l.fixEolChars(i.text.substring(0,i.start)),t.startTag="",t.selection=l.fixEolChars(i.text.substring(i.start,i.end)),t.endTag="",t.after=l.fixEolChars(i.text.substring(i.end)),t.scrollTop=i.scrollTop,t},this.setChunks=function(e){e.before=e.before+e.startTag,e.after=e.endTag+e.after,this.start=e.before.length,this.end=e.before.length+e.selection.length,this.text=e.before+e.selection+e.after,this.scrollTop=e.scrollTop},this.init()}function r(e,t,n){var i,r,o,a=3e3,s="delayed",d=function(e,t){l.addEvent(e,"input",t),e.onpaste=t,e.ondrop=t,l.addEvent(e,"keypress",t),l.addEvent(e,"keydown",t)},p=function(){var e=0;return window.innerHeight?e=window.pageYOffset:u.documentElement&&u.documentElement.scrollTop?e=u.documentElement.scrollTop:u.body&&(e=u.body.scrollTop),e},f=function(){if(t.preview){var n=t.input.value;if(!n||n!=o){o=n;var i=(new Date).getTime();n=e.makeHtml(n);var a=(new Date).getTime();r=a-i,C(n)}}},g=function(){if(i&&(clearTimeout(i),i=void 0),"manual"!==s){var e=0;"delayed"===s&&(e=r),e>a&&(e=a),i=setTimeout(f,e)}},m=function(e){return e.scrollHeight<=e.clientHeight?1:e.scrollTop/(e.scrollHeight-e.clientHeight)},v=function(){t.preview&&(t.preview.scrollTop=(t.preview.scrollHeight-t.preview.clientHeight)*m(t.preview))};this.refresh=function(e){e?(o="",f()):g()},this.processingTime=function(){return r};var b,T=!0,w=function(e){var n=t.preview,i=n.parentNode,r=n.nextSibling;i.removeChild(n),n.innerHTML=e,r?i.insertBefore(n,r):i.appendChild(n)},y=function(e){t.preview.innerHTML=e},x=function(e){if(b)return b(e);try{y(e),b=y}catch(t){b=w,b(e)}},C=function(e){var i=c.getTop(t.input)-p();if(t.preview&&(x(e),n()),v(),T)T=!1;else{var r=c.getTop(t.input)-p();h.isIE?setTimeout(function(){window.scrollBy(0,r-i)},0):window.scrollBy(0,r-i)}},k=function(){d(t.input,g),f(),t.preview&&(t.preview.scrollTop=0)};k()}function o(e,t,n,r,o,a,s){function c(e){if(v.focus(),e.textOp){n&&n.setCommandMode();var o=new i(t);if(!o)return;var a=o.getChunks(),s=function(){v.focus(),a&&o.setChunks(a),o.restore(),r.refresh()},l=e.textOp(a,s);l||s()}e.execute&&e.execute(n)}function d(e,n){var i="0px",r="-20px",o="-40px",a=e.getElementsByTagName("span")[0];n?(a.style.backgroundPosition=e.XShift+" "+i,e.onmouseover=function(){a.style.backgroundPosition=this.XShift+" "+o},e.onmouseout=function(){a.style.backgroundPosition=this.XShift+" "+i},h.isIE&&(e.onmousedown=function(){u.activeElement&&u.activeElement!==t.input||(t.ieCachedRange=document.selection.createRange(),t.ieCachedScrollTop=t.input.scrollTop)}),e.isHelp||(e.onclick=function(){return this.onmouseout&&this.onmouseout(),c(this),!1})):(a.style.backgroundPosition=e.XShift+" "+r,e.onmouseover=e.onmouseout=e.onclick=function(){})}function p(e){return"string"==typeof e&&(e=o[e]),function(){e.apply(o,arguments)}}function g(){var n=t.buttonBar,i=document.createElement("ul");i.id="wmd-button-row"+e,i.className="wmd-button-row",i=n.appendChild(i);var r=0,o=function(t,n,o,a){var s=document.createElement("li");s.className="wmd-button",s.style.left=r+"px",r+=25;var l=document.createElement("span");return s.id=t+e,s.appendChild(l),s.title=n,s.XShift=o,a&&(s.textOp=a),d(s,!0),i.appendChild(s),s},a=function(t){var n=document.createElement("li");n.className="wmd-spacer wmd-spacer"+t,n.id="wmd-spacer"+t+e,i.appendChild(n),r+=25};b.bold=o("wmd-bold-button",s("bold"),"0px",p("doBold")),b.italic=o("wmd-italic-button",s("italic"),"-20px",p("doItalic")),a(1),b.link=o("wmd-link-button",s("link"),"-40px",p(function(e,t){return this.doLinkOrImage(e,t,!1)})),b.quote=o("wmd-quote-button",s("quote"),"-60px",p("doBlockquote")),b.code=o("wmd-code-button",s("code"),"-80px",p("doCode"));var l=document.createElement("li");l.textOp=p("doTab"),b.tab=l,b.image=o("wmd-image-button",s("image"),"-100px",p(function(e,t){return this.doLinkOrImage(e,t,!0)})),a(2),b.olist=o("wmd-olist-button",s("olist"),"-120px",p(function(e,t){this.doList(e,t,!0)})),b.ulist=o("wmd-ulist-button",s("ulist"),"-140px",p(function(e,t){this.doList(e,t,!1)})),b.heading=o("wmd-heading-button",s("heading"),"-160px",p("doHeading")),b.hr=o("wmd-hr-button",s("hr"),"-180px",p("doHorizontalRule")),a(3),b.undo=o("wmd-undo-button",s("undo"),"-200px",null),b.undo.execute=function(e){e&&e.undo()};var c=/win/.test(f.platform.toLowerCase())?s("redo"):s("redomac");b.redo=o("wmd-redo-button",c,"-220px",null),b.redo.execute=function(e){e&&e.redo()},m()}function m(){n&&(d(b.undo,n.canUndo()),d(b.redo,n.canRedo()))}var v=t.input,b={};g();var T="keydown";h.isOpera&&(T="keypress"),l.addEvent(v,T,function(e){if(!e.ctrlKey&&!e.metaKey||e.altKey||e.shiftKey)9===e.keyCode&&(e.preventDefault(),c(b.tab));else{var t=e.charCode||e.keyCode,n=String.fromCharCode(t).toLowerCase();switch(n){case"b":c(b.bold);break;case"i":c(b.italic);break;case"l":c(b.link);break;case"q":c(b.quote);break;case"k":c(b.code);break;case"g":c(b.image);break;case"o":c(b.olist);break;case"u":c(b.ulist);break;case"h":c(b.heading);break;case"r":c(b.hr);break;case"y":c(b.redo);break;case"z":e.shiftKey?c(b.redo):c(b.undo);break;default:return}e.preventDefault&&e.preventDefault(),window.event&&(window.event.returnValue=!1)}}),l.addEvent(v,"keyup",function(e){if(e.shiftKey&&!e.ctrlKey&&!e.metaKey){var t=e.charCode||e.keyCode;if(13===t){var n={};n.textOp=p("doAutoindent"),c(n)}}}),h.isIE&&l.addEvent(v,"keydown",function(e){var t=e.keyCode;if(27===t)return!1}),this.setUndoRedoButtonStates=m}function a(e,t){this.hooks=e,this.getString=t}function s(e){return e.replace(/^\s*(.*?)(?:\s+"(.+)")?\s*$/,function(e,t,n){return t=t.replace(/\?.*$/,function(e){return e.replace(/\+/g," ")}),t=decodeURIComponent(t),t=encodeURI(t).replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29"),t=t.replace(/\?.*$/,function(e){return e.replace(/\+/g,"%2b")}),n&&(n=n.trim?n.trim():n.replace(/^\s*/,"").replace(/\s*$/,""),n=n.replace(/"/g,"quot;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;").replace(/</g,"&lt;").replace(/>/g,"&gt;")),n?t+' "'+n+'"':t})}var l={},c={},d={},u=window.document,p=window.RegExp,f=window.navigator,g={lineLength:72},h={isIE:/msie/.test(f.userAgent.toLowerCase()),isIE_5or6:/msie 6/.test(f.userAgent.toLowerCase())||/msie 5/.test(f.userAgent.toLowerCase()),isOpera:/opera/.test(f.userAgent.toLowerCase())},m={bold:"Strong <strong> Ctrl+B",boldexample:"strong text",italic:"Emphasis <em> Ctrl+I",italicexample:"emphasized text",link:"Hyperlink <a> Ctrl+L",linkdescription:"enter link description here",linkdialog:'<p><b>Insert Hyperlink</b></p><p>http://example.com/ "optional title"</p>',quote:"Blockquote <blockquote> Ctrl+Q",quoteexample:"Blockquote",code:"Code Sample <pre><code> Ctrl+K",codeexample:"enter code here",image:"Image <img> Ctrl+G",imagedescription:"enter image description here",imagedialog:"<p><b>Insert Image</b></p>",olist:"Numbered List <ol> Ctrl+O",ulist:"Bulleted List <ul> Ctrl+U",litem:"List item",heading:"Heading <h1>/<h2> Ctrl+H",headingexample:"Heading",hr:"Horizontal Rule <hr> Ctrl+R",undo:"Undo - Ctrl+Z",redo:"Redo - Ctrl+Y",redomac:"Redo - Ctrl+Shift+Z",help:"Markdown Editing Help"},v="http://",b="http://";Markdown.Editor=function(e,i,s){s=s||{},"function"==typeof s.handler&&(s={helpButton:s}),s.strings=s.strings||{},s.helpButton&&(s.strings.help=s.strings.help||s.helpButton.title);var l=function(e){return s.strings[e]||m[e]};i=i||"";var c=this.hooks=new Markdown.HookCollection;c.addNoop("onPreviewRefresh"),c.addNoop("postBlockquoteCreation"),c.addFalse("insertImageDialog"),this.getConverter=function(){return e};var d,p=this;this.run=function(){if(!d){d=new t(i);var f,g,h=new a(c,l),m=new r(e,d,function(){c.onPreviewRefresh()});/\?noundo/.test(u.location.href)||(f=new n(function(){m.refresh(),g&&g.setUndoRedoButtonStates()},d),this.textOperation=function(e){f.setCommandMode(),e(),p.refreshPreview()}),g=new o(i,d,f,m,h,s.helpButton,l),g.setUndoRedoButtonStates();var v=p.refreshPreview=function(){m.refresh(!0)};v()}}},e.prototype.findTags=function(e,t){var n,i=this;e&&(n=l.extendRegExp(e,"","$"),this.before=this.before.replace(n,function(e){return i.startTag=i.startTag+e,""}),n=l.extendRegExp(e,"^",""),this.selection=this.selection.replace(n,function(e){return i.startTag=i.startTag+e,""})),t&&(n=l.extendRegExp(t,"","$"),this.selection=this.selection.replace(n,function(e){return i.endTag=e+i.endTag,""}),n=l.extendRegExp(t,"^",""),this.after=this.after.replace(n,function(e){return i.endTag=e+i.endTag,""}))},e.prototype.trimWhitespace=function(e){var t,n,i=this;e?t=n="":(t=function(e){return i.before+=e,""},n=function(e){return i.after=e+i.after,""}),this.selection=this.selection.replace(/^(\s*)/,t).replace(/(\s*)$/,n)},e.prototype.skipLines=function(e,t,n){var i,r;if(void 0===e&&(e=1),void 0===t&&(t=1),e++,t++,navigator.userAgent.match(/Chrome/)&&"X".match(/()./),this.selection=this.selection.replace(/(^\n*)/,""),this.startTag=this.startTag+p.$1,this.selection=this.selection.replace(/(\n*$)/,""),this.endTag=this.endTag+p.$1,this.startTag=this.startTag.replace(/(^\n*)/,""),this.before=this.before+p.$1,this.endTag=this.endTag.replace(/(\n*$)/,""),this.after=this.after+p.$1,this.before){for(i=r="";e--;)i+="\\n?",r+="\n";n&&(i="\\n*"),this.before=this.before.replace(new p(i+"$",""),r)}if(this.after){for(i=r="";t--;)i+="\\n?",r+="\n";n&&(i="\\n*"),this.after=this.after.replace(new p(i,""),r)}},l.isVisible=function(e){return window.getComputedStyle?"none"!==window.getComputedStyle(e,null).getPropertyValue("display"):e.currentStyle?"none"!==e.currentStyle.display:void 0},l.addEvent=function(e,t,n){e.attachEvent?e.attachEvent("on"+t,n):e.addEventListener(t,n,!1)},l.removeEvent=function(e,t,n){e.detachEvent?e.detachEvent("on"+t,n):e.removeEventListener(t,n,!1)},l.fixEolChars=function(e){return e=e.replace(/\r\n/g,"\n"),e=e.replace(/\r/g,"\n"),e},l.extendRegExp=function(e,t,n){null==t&&(t=""),null==n&&(n="");var i,r=e.toString();return r=r.replace(/\/([gim]*)$/,function(e,t){return i=t,""}),r=r.replace(/(^\/|\/$)/g,""),r=t+r+n,new p(r,i)},c.getTop=function(e,t){var n=e.offsetTop;if(!t)for(;e=e.offsetParent;)n+=e.offsetTop;return n},c.getHeight=function(e){return e.offsetHeight||e.scrollHeight},c.getWidth=function(e){return e.offsetWidth||e.scrollWidth},c.getPageSize=function(){var e,t,n,i;self.innerHeight&&self.scrollMaxY?(e=u.body.scrollWidth,t=self.innerHeight+self.scrollMaxY):u.body.scrollHeight>u.body.offsetHeight?(e=u.body.scrollWidth,t=u.body.scrollHeight):(e=u.body.offsetWidth,t=u.body.offsetHeight),self.innerHeight?(n=self.innerWidth,i=self.innerHeight):u.documentElement&&u.documentElement.clientHeight?(n=u.documentElement.clientWidth,i=u.documentElement.clientHeight):u.body&&(n=u.body.clientWidth,i=u.body.clientHeight);var r=Math.max(e,n),o=Math.max(t,i);return[r,o,n,i]},d.createBackground=function(){var e=u.createElement("div"),t=e.style;e.className="wmd-prompt-background",t.position="absolute",t.top="0",t.zIndex="1000",h.isIE?t.filter="alpha(opacity=50)":t.opacity="0.5";var n=c.getPageSize();return t.height=n[1]+"px",h.isIE?(t.left=u.documentElement.scrollLeft,t.width=u.documentElement.clientWidth):(t.left="0",t.width="100%"),u.body.appendChild(e),e},d.prompt=function(e,t,n,i=!1){var r,o,a,s,d,p;void 0===t&&(t="");var f=function(e){var t=e.charCode||e.keyCode;27===t&&g(!0)},g=function(e){l.removeEvent(u.body,"keydown",f);var t=o.value;if(e)t=null;else{if(i){if(s.textContent="",d.setAttribute("disabled",!0),p.setAttribute("disabled",!0),""!=a.value){var c=new FormData,g=$('input[name="uploadSupportImage"]').get(0).files[0];return c.append("action","mdb_forum_upload_image"),c.append("image",g),g.size>2e6?(d.removeAttribute("disabled"),p.removeAttribute("disabled"),s.textContent="Image is too big! Max. 2MB",!1):($("#uploadImageLoader").show(),$.ajax({url:ajax_url,method:"POST",data:c,contentType:!1,processData:!1}).done(function(e){e=JSON.parse(e),e.status?(r.parentNode.removeChild(r),d.removeAttribute("disabled"),p.removeAttribute("disabled"),$("#uploadImageLoader").hide(),n(e.url)):($("#uploadImageLoader").hide(),d.removeAttribute("disabled"),p.removeAttribute("disabled"),s.textContent=e.message)}).fail(function(){$("#uploadImageLoader").hide(),d.removeAttribute("disabled"),p.removeAttribute("disabled"),s.textContent="Error, please try again"}),!1)}if(""==t&&""==a.value)return $("#uploadImageLoader").hide(),d.removeAttribute("disabled"),p.removeAttribute("disabled"),s.textContent="Please fill out at least one field",!1}t=t.replace(/^http:\/\/(https?|ftp):\/\//,"$1://"),/^(?:https?|ftp):\/\//.test(t)||(t="http://"+t)}return r.parentNode.removeChild(r),n(t),!1},m=function(){r=u.createElement("div"),r.className="wmd-prompt-dialog p-1",r.style.position="fixed",r.style.width="500px",r.style.zIndex="1001";var t=u.createElement("div");t.innerHTML=e,t.style.padding="5px",r.appendChild(t);var n=u.createElement("form"),m=n.style;if(n.onsubmit=function(){return g(!1)},m.padding="0",m.margin="0",m.cssFloat="left",m.width="100%",m.textAlign="center",m.position="relative",n.setAttribute("class","md-form"),r.appendChild(n),i){s=u.createElement("span"),s.className="text-danger",n.appendChild(s);var v=u.createElement("span");v.setAttribute("id","uploadImageLoader"),v.setAttribute("role","status"),v.style="display: none",v.className="spinner-grow",n.appendChild(v);var b=u.createElement("div");b.className="file-field p-2",n.appendChild(b);var T=u.createElement("div");T.className="btn btn-primary btn-sm float-left",b.appendChild(T);var w=u.createElement("span");w.textContent="Choose image",T.appendChild(w),a=u.createElement("input"),a.type="file",a.setAttribute("name","uploadSupportImage"),T.appendChild(a);var y=u.createElement("div");y.className="file-path-wrapper",b.appendChild(y);var x=u.createElement("input");x.className="file-path validate",x.type="text",x.setAttribute("placeholder","Upload your file"),y.appendChild(x);var C=u.createElement("p");C.className="p-2",C.textContent="or paste external image link",n.appendChild(C)}o=u.createElement("input"),o.type="text";var k=i?"External image link":"http://";o.setAttribute("placeholder",k),m=o.style,m.display="block",m.width="80%",m.marginLeft=m.marginRight="auto",n.appendChild(o),d=u.createElement("input"),d.type="button",d.onclick=function(){return g(!1)},d.value="OK",d.className="btn btn-primary btn-sm m-4",p=u.createElement("input"),p.type="button",p.onclick=function(){return g(!0)},p.value="Cancel",p.className="btn btn-primary btn-sm m-4",n.appendChild(d),n.appendChild(p),l.addEvent(u.body,"keydown",f),r.style.top="50%",r.style.left="50%",r.style.display="block",h.isIE_5or6&&(r.style.position="absolute",r.style.top=u.documentElement.scrollTop+200+"px",r.style.left="50%"),u.body.appendChild(r),r.style.marginTop=-c.getHeight(r)/2+"px",r.style.marginLeft=-c.getWidth(r)/2+"px"};setTimeout(function(){m();var e=t.length;if(void 0!==o.selectionStart)o.selectionStart=0,o.selectionEnd=e;else if(o.createTextRange){var n=o.createTextRange();n.collapse(!1),n.moveStart("character",-e),n.moveEnd("character",e),n.select()}o.focus()},0)};var T=a.prototype;T.prefixes="(?:\\s{4,}|\\s*>|\\s*-\\s+|\\s*\\d+\\.|=|\\+|-|_|\\*|#|\\s*\\[[^\n]]+\\]:)",T.unwrap=function(e){var t=new p("([^\\n])\\n(?!(\\n|"+this.prefixes+"))","g");e.selection=e.selection.replace(t,"$1 $2")},T.wrap=function(e,t){this.unwrap(e);var n=new p("(.{1,"+t+"})( +|$\\n?)","gm"),i=this;e.selection=e.selection.replace(n,function(e,t){return new p("^"+i.prefixes,"").test(e)?e:t+"\n"}),e.selection=e.selection.replace(/\s+$/,"")},T.doBold=function(e,t){return this.doBorI(e,t,2,this.getString("boldexample"))},T.doItalic=function(e,t){return this.doBorI(e,t,1,this.getString("italicexample"))},T.doTab=function(e){e.before=e.before+"    "},T.doBorI=function(e,t,n,i){e.trimWhitespace(),e.selection=e.selection.replace(/\n{2,}/g,"\n");var r=/(\**$)/.exec(e.before)[0],o=/(^\**)/.exec(e.after)[0],a=Math.min(r.length,o.length);if(a>=n&&(2!=a||1!=n))e.before=e.before.replace(p("[*]{"+n+"}$",""),""),e.after=e.after.replace(p("^[*]{"+n+"}",""),"");else if(!e.selection&&o){e.after=e.after.replace(/^([*_]*)/,""),e.before=e.before.replace(/(\s?)$/,"");var s=p.$1;e.before=e.before+o+s}else{e.selection||o||(e.selection=i);var l=n<=1?"*":"**";e.before=e.before+l,e.after=l+e.after}},T.stripLinkDefs=function(e,t){return e=e.replace(/^[ ]{0,3}\[(\d+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|$)/gm,function(e,n,i,r,o){return t[n]=e.replace(/\s*$/,""),r?(t[n]=e.replace(/["(](.+?)[")]$/,""),r+o):""}),e},T.addLinkDef=function(e,t){var n=0,i={};e.before=this.stripLinkDefs(e.before,i),e.selection=this.stripLinkDefs(e.selection,i),e.after=this.stripLinkDefs(e.after,i);var r="",o=/(\[)((?:\[[^\]]*\]|[^\[\]])*)(\][ ]?(?:\n[ ]*)?\[)(\d+)(\])/g,a=function(e){n++,e=e.replace(/^[ ]{0,3}\[(\d+)\]:/,"  ["+n+"]:"),r+="\n"+e},s=function(e,t,r,l,c,d){return r=r.replace(o,s),i[c]?(a(i[c]),t+r+l+n+d):e};e.before=e.before.replace(o,s),t?a(t):e.selection=e.selection.replace(o,s);var l=n;return e.after=e.after.replace(o,s),e.after&&(e.after=e.after.replace(/\n*$/,"")),e.after||(e.selection=e.selection.replace(/\n*$/,"")),e.after+="\n\n"+r,l},T.doLinkOrImage=function(e,t,n){var i;if(e.trimWhitespace(),e.findTags(/\s*!?\[/,/\][ ]?(?:\n[ ]*)?(\[.*?\])?/),!(e.endTag.length>1&&e.startTag.length>0)){if(e.selection=e.startTag+e.selection+e.endTag,e.startTag=e.endTag="",/\n\n/.test(e.selection))return void this.addLinkDef(e,null);var r=this,o=function(o){if(i.parentNode.removeChild(i),null!==o){e.selection=(" "+e.selection).replace(/([^\\](?:\\\\)*)(?=[[\]])/g,"$1\\").substr(1);var a=" [999]: "+s(o),l=r.addLinkDef(e,a);e.startTag=n?"![":"[",e.endTag="]["+l+"]",e.selection||(e.selection=n?r.getString("imagedescription"):r.getString("linkdescription"))}t()};return i=d.createBackground(),n?this.hooks.insertImageDialog(o)||d.prompt(this.getString("imagedialog"),v,o,!0):d.prompt(this.getString("linkdialog"),b,o),!0}e.startTag=e.startTag.replace(/!?\[/,""),e.endTag="",this.addLinkDef(e,null)},T.doAutoindent=function(e,t){var n=this,i=!1;e.before=e.before.replace(/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]*\n$/,"\n\n"),e.before=e.before.replace(/(\n|^)[ ]{0,3}>[ \t]*\n$/,"\n\n"),e.before=e.before.replace(/(\n|^)[ \t]+\n$/,"\n\n"),e.selection||/^[ \t]*(?:\n|$)/.test(e.after)||(e.after=e.after.replace(/^[^\n]*/,function(t){return e.selection=t,""}),i=!0),/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]+.*\n$/.test(e.before)&&n.doList&&n.doList(e),/(\n|^)[ ]{0,3}>[ \t]+.*\n$/.test(e.before)&&n.doBlockquote&&n.doBlockquote(e),/(\n|^)(\t|[ ]{4,}).*\n$/.test(e.before)&&n.doCode&&n.doCode(e),i&&(e.after=e.selection+e.after,e.selection="")},T.doBlockquote=function(e,t){e.selection=e.selection.replace(/^(\n*)([^\r]+?)(\n*)$/,function(t,n,i,r){return e.before+=n,e.after=r+e.after,i}),e.before=e.before.replace(/(>[ \t]*)$/,function(t,n){return e.selection=n+e.selection,""}),e.selection=e.selection.replace(/^(\s|>)+$/,""),e.selection=e.selection||this.getString("quoteexample");var n,i="",r="";if(e.before){for(var o=e.before.replace(/\n$/,"").split("\n"),a=!1,s=0;s<o.length;s++){var l=!1;n=o[s],a=a&&n.length>0,/^>/.test(n)?(l=!0,!a&&n.length>1&&(a=!0)):l=!!/^[ \t]*$/.test(n)||a,l?i+=n+"\n":(r+=i+n,i="\n")}/(^|\n)>/.test(i)||(r+=i,i="")}e.startTag=i,e.before=r,e.after&&(e.after=e.after.replace(/^\n?/,"\n")),e.after=e.after.replace(/^(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*)/,function(t){return e.endTag=t,""});var c=function(t){var n=t?"> ":"";e.startTag&&(e.startTag=e.startTag.replace(/\n((>|\s)*)\n$/,function(e,t){return"\n"+t.replace(/^[ ]{0,3}>?[ \t]*$/gm,n)+"\n"})),e.endTag&&(e.endTag=e.endTag.replace(/^\n((>|\s)*)\n/,function(e,t){return"\n"+t.replace(/^[ ]{0,3}>?[ \t]*$/gm,n)+"\n"}))};/^(?![ ]{0,3}>)/m.test(e.selection)?(this.wrap(e,g.lineLength-2),e.selection=e.selection.replace(/^/gm,"> "),c(!0),e.skipLines()):(e.selection=e.selection.replace(/^[ ]{0,3}> ?/gm,""),this.unwrap(e),c(!1),!/^(\n|^)[ ]{0,3}>/.test(e.selection)&&e.startTag&&(e.startTag=e.startTag.replace(/\n{0,2}$/,"\n\n")),!/(\n|^)[ ]{0,3}>.*$/.test(e.selection)&&e.endTag&&(e.endTag=e.endTag.replace(/^\n{0,2}/,"\n\n"))),e.selection=this.hooks.postBlockquoteCreation(e.selection),/\n/.test(e.selection)||(e.selection=e.selection.replace(/^(> *)/,function(t,n){return e.startTag+=n,""}))},T.doCode=function(e,t){var n=/\S[ ]*$/.test(e.before),i=/^[ ]*\S/.test(e.after);if(!i&&!n||/\n/.test(e.selection)){e.before=e.before.replace(/[ ]{4}$/,function(t){return e.selection=t+e.selection,""});var r=1,o=1;/(\n|^)(\t|[ ]{4,}).*\n$/.test(e.before)&&(r=0),/^\n(\t|[ ]{4,})/.test(e.after)&&(o=0),e.skipLines(r,o),e.selection?/^[ ]{0,3}\S/m.test(e.selection)?/\n/.test(e.selection)?e.selection=e.selection.replace(/^/gm,"    "):e.before+="    ":e.selection=e.selection.replace(/^(?:[ ]{4}|[ ]{0,3}\t)/gm,""):(e.startTag="    ",e.selection=this.getString("codeexample"))}else e.trimWhitespace(),e.findTags(/`/,/`/),e.startTag||e.endTag?e.endTag&&!e.startTag?(e.before+=e.endTag,e.endTag=""):e.startTag=e.endTag="":(e.startTag=e.endTag="`",e.selection||(e.selection=this.getString("codeexample")))},T.doList=function(e,t,n){var i=/(\n|^)(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*$/,r=/^\n*(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*/,o="-",a=1,s=function(){var e;return n?(e=" "+a+". ",a++):e=" "+o+" ",e},l=function(e){return void 0===n&&(n=/^\s*\d/.test(e)),e=e.replace(/^[ ]{0,3}([*+-]|\d+[.])\s/gm,function(e){return s()}),e};if(e.findTags(/(\n|^)*[ ]{0,3}([*+-]|\d+[.])\s+/,null),!e.before||/\n$/.test(e.before)||/^\n/.test(e.startTag)||(e.before+=e.startTag,e.startTag=""),e.startTag){var c=/\d+[.]/.test(e.startTag);if(e.startTag="",e.selection=e.selection.replace(/\n[ ]{4}/g,"\n"),this.unwrap(e),e.skipLines(),c&&(e.after=e.after.replace(r,l)),n==c)return}var d=1;e.before=e.before.replace(i,function(e){return/^\s*([*+-])/.test(e)&&(o=p.$1),d=/[^\n]\n\n[^\n]/.test(e)?1:0,l(e)}),e.selection||(e.selection=this.getString("litem"));var u=s(),f=1;e.after=e.after.replace(r,function(e){return f=/[^\n]\n\n[^\n]/.test(e)?1:0,l(e)}),e.trimWhitespace(!0),e.skipLines(d,f,!0),e.startTag=u;var h=u.replace(/./g," ");this.wrap(e,g.lineLength-h.length),e.selection=e.selection.replace(/\n/g,"\n"+h)},T.doHeading=function(e,t){if(e.selection=e.selection.replace(/\s+/g," "),e.selection=e.selection.replace(/(^\s+|\s+$)/g,""),!e.selection)return e.startTag="## ",e.selection=this.getString("headingexample"),void(e.endTag=" ##");var n=0;e.findTags(/#+[ ]*/,/[ ]*#+/),/#+/.test(e.startTag)&&(n=p.lastMatch.length),e.startTag=e.endTag="",e.findTags(null,/\s?(-+|=+)/),/=+/.test(e.endTag)&&(n=1),/-+/.test(e.endTag)&&(n=2),e.startTag=e.endTag="",e.skipLines(1,1);var i=0==n?2:n-1;if(i>0){var r=i>=2?"-":"=",o=e.selection.length;for(o>g.lineLength&&(o=g.lineLength),e.endTag="\n";o--;)e.endTag+=r}},T.doHorizontalRule=function(e,t){e.startTag="----------\n",e.selection="",e.skipLines(2,1,!0)}})();